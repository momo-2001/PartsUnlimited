# Ceci est un pipeline CI/CD pour une application ASP.NET déployée sur Azure App Service.
# La version .NET a été changée à 6.x pour améliorer la compatibilité avec l'ancien code Parts Unlimited.

name: ASP.NET Core CI/CD to Azure App Service

on:
  push:
    branches: [ master ]
  workflow_dispatch:

# Variables que vous avez définies pour votre déploiement
env:
  AZURE_WEBAPP_NAME: parts-unlimited-moo-lah-dev-ane5bcgjfge7d9f5    # Nom de votre App Service
  AZURE_WEBAPP_PACKAGE_PATH: '.'  # Chemin du paquet après la publication
  DOTNET_VERSION: '6.x'           # Version corrigée pour la compatibilité (6.x)
  SOLUTION_PATH: 'env/PartsUnlimited.Environment/PartsUnlimited.Environment.sln' # Chemin exact de la solution que vous avez trouvé

jobs:
  build:
    # ----------------------------------------------------
    # JOB DE BUILD (Intégration Continue - CI)
    # ----------------------------------------------------
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    # 1. Configuration de l'environnement .NET
    - name: Set up DOTNET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true

    # 2. Restauration des dépendances et Compilation (Utilisation du chemin exact)
    - name: Restore, Build, and Publish
      shell: pwsh
      run: |
        # Restaure les paquets NuGet en forçant l'opération pour contourner l'erreur de "lock file"
        dotnet restore ${{ env.SOLUTION_PATH }} --force 
        
        # Compile la solution
        dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore
        
        # Publie l'application web pour le déploiement
        dotnet publish ${{ env.SOLUTION_PATH }} --configuration Release --no-build --output ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/published_app

    # 3. Préparation de l'Artéfact pour le déploiement (CD)
    - name: Upload artifact for deployment
      uses: actions/upload-artifact@v4
      with:
        name: dotnet-app
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/published_app
        
  deploy:
    # ----------------------------------------------------
    # JOB DE DÉPLOIEMENT (Déploiement Continu - CD)
    # ----------------------------------------------------
    needs: build # Ne s'exécute que si le job 'build' est VERT
    runs-on: windows-latest
    environment:
      name: 'Development' # Peut être ajusté (Staging, Production)
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
    # 1. Téléchargement de l'Artéfact depuis le job 'build'
    - name: Download artifact from build job
      uses: actions/download-artifact@v4
      with:
        name: dotnet-app
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    # 2. Déploiement sur Azure App Service (Utilisation du secret AZURE_CREDENTIALS)
    - name: Deploy to Azure WebApp
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        slot-name: 'Production'
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        publish-profile: ${{ secrets.AZURE_CREDENTIALS }}
