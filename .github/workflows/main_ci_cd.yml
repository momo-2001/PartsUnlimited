# Nom du workflow (s'affiche dans GitHub Actions)
name: ASP.NET Framework CI/CD to Azure App Service

# VARIABLES GLOBALES
env:
  # Remplacé par le nom exact de votre App Service Windows
  AZURE_WEBAPP_NAME: parts-unlimited-moo-lah-dev-ane5bcgjfge7d9f5
  # Chemin vers le fichier de solution que vous avez trouvé
  SOLUTION_PATH: env/PartsUnlimited.Environment/PartsUnlimited.Environment.sln
  # Dossier de publication de l'application web (le VSBuild crée un .zip ici)
  AZURE_WEBAPP_PACKAGE_PATH: '$(System.DefaultWorkingDirectory)/drop' 

# Déclenche le workflow à chaque push sur la branche 'master' (CI)
on:
  push:
    branches: [ master ]
  workflow_dispatch:

# Définition des jobs (tâches)
jobs:
  build:
    # Utilise l'agent Windows pour la compilation du Framework .NET classique
    runs-on: windows-latest
    
    # OUTPUTS: définit une sortie pour passer le chemin de l'artefact au job 'deploy'
    outputs:
      webapp-package-path: ${{ steps.publish.outputs.webapp-package-path }}
      
    steps:
    # 1. Checkout du code
    - uses: actions/checkout@v4
    
    # 2. Setup du Framework .NET
    - name: Setup MSBuild and NuGet
      uses: microsoft/setup-msbuild@v2

    # 3. Restauration des dépendances
    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_PATH }}
      
    # 4. Build de la solution (Compilation)
    - name: Build the solution
      run: |
        msbuild ${{ env.SOLUTION_PATH }} /p:Configuration=Release /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(System.DefaultWorkingDirectory)\drop"

    # 5. Exécution des tests (non configuré pour ce template, mais inclus)
    - name: Run Tests
      # Nous sautons VSTest pour le moment pour ne pas bloquer si les tests manquent
      run: echo "Tests VSTest skipped for initial deployment."
    
    # 6. Publication de l'Artéfact de Build
    - name: Publish Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dotnet-app
        path: '$(System.DefaultWorkingDirectory)/drop' # Publie le dossier 'drop' créé par msbuild

  deploy:
    runs-on: windows-latest
    needs: build # Dépend de la réussite du job 'build'
    environment:
      name: 'Development' # Nom de l'environnement, peut être remplacé
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
      
    steps:
    # 1. Téléchargement de l'Artéfact
    - name: Download Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: dotnet-app
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        
    # 2. Déploiement vers Azure App Service
    - name: Deploy to Azure WebApp
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v3
      with:
        # Secret créé précédemment dans Azure Cloud Shell
        publish-profile: ${{ secrets.AZURE_CREDENTIALS }} 
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }} # Utilise le package téléchargé
