# Nom du workflow (s'affiche sur l'onglet Actions)
name: ASP.NET Core CI/CD to Azure App Service

# Déclenche le workflow à chaque push sur la branche 'master' (CI)
on:
  push:
    branches: [ master ]
  workflow_dispatch:

# Variables d'environnement pour le pipeline
env:
  AZURE_WEBAPP_NAME: 'parts-unlimited-moo-lah-dev-ane5bcgjfge7d9f5'    # Remplacez par le nom de votre App Service
  AZURE_WEBAPP_PACKAGE_PATH: '.'                           # Chemin vers le paquet de déploiement (le dossier courant après publish)
  DOTNET_VERSION: '8.x'                                    # Version du .NET Core/Framework
  # CORRECTION FINALE DU CHEMIN : Cherche tous les fichiers .csproj dans les sous-dossiers
  SOLUTION_PATH: '**/*.csproj'                             # Cibler tous les fichiers projet

jobs:
  build:
    # Intégration Continue (CI): Compiler, Tester, Publier l'Artéfact
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. Configuration de l'environnement .NET
    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # 2. Restauration des dépendances et compilation
    # On utilise SOLUTION_PATH: **/*.csproj car le fichier .sln n'est pas trouvé
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore
      
    # 3. Exécution des tests (Ignoré si aucun projet de test n'est trouvé)
    - name: Test
      run: dotnet test ${{ env.SOLUTION_PATH }} --no-build --verbosity normal

    # 4. Publication de l'application (création du paquet)
    - name: Publish web app
      run: dotnet publish ${{ env.SOLUTION_PATH }} --configuration Release --no-build --output ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/publish
    
    # 5. Téléchargement de l'artéfact pour le job 'deploy'
    - name: Upload artifact for deployment
      uses: actions/upload-artifact@v4
      with:
        name: dotnet-app
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/publish

  deploy:
    # Déploiement Continu (CD): Déploiement sur Azure App Service
    runs-on: windows-latest
    needs: build # Dépend de la réussite du job 'build'
    environment:
      name: 'Development' # Environnement de déploiement (peut être changé)
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
    # 1. Téléchargement de l'Artéfact du job 'build'
    - name: Download artifact from build job
      uses: actions/download-artifact@v4
      with:
        name: dotnet-app
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    # 2. Déploiement vers Azure App Service
    - name: 'Deploy to Azure WebApp'
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v3
      with:
        # Secret créé précédemment dans GitHub pour l'authentification Azure
        publish-profile: ${{ secrets.AZURE_CREDENTIALS }}
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
